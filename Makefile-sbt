# Cross-compilation
CROSS_COMPILE?=arm-linux-gnueabihf-
processors=$(shell grep -c ^processor /proc/cpuinfo)
cflags="-O2 -mtune=cortex-a9 -mfpu=neon -mfloat-abi=hard"
makecmd=CROSS_COMPILE=$(CROSS_COMPILE) $(MAKE) -j $(processors) \
	ARCH=arm CFLAGS=$(cflags)

.PHONY: arch/arm/boot/uImage
arch/arm/boot/uImage: .config
	$(makecmd) UIMAGE_LOADADDR=0x8000 uImage

modules = drivers/staging/fbtft/fbtft_device.ko \
          drivers/staging/fbtft/flexfb.ko
.PHONY: $(modules)
$(modules): .config
	$(makecmd) modules

.config: arch/arm/configs/green_mango_defconfig
	$(makecmd) ARCH=arm green_mango_defconfig

.PHONY: install-remote
install-remote: REMOTE_HOST_defined arch/arm/boot/uImage
	@echo "Installing to $(REMOTE_HOST)..."
	ssh $(REMOTE_HOST) "mount -o rw,remount \$$(readlink /media/active_system)"
	scp arch/arm/boot/uImage $(REMOTE_HOST):/boot/uImage
	ssh $(REMOTE_HOST) "mount -o ro,remount \$$(readlink /media/active_system)"
	@echo "Successfully installed to $(REMOTE_HOST)."

.PHONY: REMOTE_HOST_defined
REMOTE_HOST_defined:
ifndef REMOTE_HOST
	$(error REMOTE_HOST is not set)
endif
