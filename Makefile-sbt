# Cross-compilation
uboot_tools=/projects/green-mango/firmware/u-boot/tools
CROSS_COMPILE?=arm-linux-gnueabihf-
processors=$(shell grep -c ^processor /proc/cpuinfo)
cflags="-O2 -mtune=cortex-a9 -mfpu=neon -mfloat-abi=hard"
makecmd=CROSS_COMPILE=$(CROSS_COMPILE) $(MAKE) -j $(processors) \
	ARCH=arm CFLAGS=$(cflags)

.PHONY: arch/arm/boot/uImage
arch/arm/boot/uImage: .config
	PATH=$(PATH):$(uboot_tools) $(makecmd) UIMAGE_LOADADDR=0x8000 uImage

modules = drivers/staging/fbtft/fbtft_device.ko \
          drivers/staging/fbtft/flexfb.ko
.PHONY: $(modules)
$(modules): .config
	$(makecmd) modules

.config: arch/arm/configs/green_mango_defconfig
	$(makecmd) ARCH=arm green_mango_defconfig

.PHONY: install-remote
install-remote: remote_host_defined arch/arm/boot/uImage
	@echo "Installing to $(remote_host)..."
	ssh $(remote_host) "mount -o rw,remount \$$(readlink /media/system)"
	scp arch/arm/boot/uImage $(remote_host):/boot/uImage
	ssh $(remote_host) "mount -o ro,remount \$$(readlink /media/system)"
	@echo "Successfully installed to $(remote_host)."

.PHONY: remote_host_defined
remote_host_defined:
ifndef remote_host
	$(error remote_host is not set)
endif
